#!/usr/bin/env zsh

N_ID=37
SECONDS_T=$((24 * 60 * 60))
ICON="/usr/share/icons/gnome/16x16/apps/system-software-update.png"

seconds_to_hms() {
    local seconds s m h

    seconds="$1"
    s=$(($seconds % 60))
    seconds=$(($seconds / 60))
    m=$(($seconds % 60))
    seconds=$(($seconds / 60))
    h=$(($seconds % 24))
    printf "${h}h ${m}m ${s}s"
}

get_update_time() {
    grep "Commandline: apt upgrade" -B 1 /var/log/apt/history.log |
        awk 'BEGIN{RS="--\n"} END{print}' |
        head -n 1 |
        cut -d " " -f 2-4 |
        xargs -i date -d {} +%s
}

main() {
    local update_t diff_t updated_at diff_txt update_msg

    update_t=$(get_update_time)
    diff_t=$(($(date +%s) - $update_t))
    updated_at=$(date -d "@${update_t}" '+%Y-%m-%d %H:%M:%S')

    diff_txt=$(seconds_to_hms $diff_t)
    update_msg="Last update was on $updated_at ($diff_txt ago)."

    printf "$update_msg\n"

    if [[ "$seconds" -gt "$SECONDS_T" ]]; then
        notify-send -u normal -r $N_ID -t 0 -i $ICON "Please update your system." $update_msg
    fi
}

main
